
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFT Simulator & Market Making Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: #111;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            min-height: 300px;
        }
        
        .panel h3 {
            color: #00ffff;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        .orderbook {
            font-size: 12px;
        }
        
        .orderbook-side {
            margin-bottom: 10px;
        }
        
        .bid { color: #00ff00; }
        .ask { color: #ff4444; }
        
        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .metric {
            background: #222;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .metric-label {
            font-size: 10px;
            color: #888;
        }
        
        .metric-value {
            font-size: 14px;
            font-weight: bold;
            color: #00ffff;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            background: #003300;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #00ff00;
            color: #000;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        input, select {
            background: #222;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
        }
        
        .log {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-size: 11px;
            white-space: pre-wrap;
        }
        
        .chart-container {
            background: #111;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            height: 400px;
        }
        
        .pnl-chart {
            width: 100%;
            height: 100%;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-online { background: #00ff00; }
        .status-offline { background: #ff4444; }
        .status-warning { background: #ffff00; }
        
        .acceleration-controls {
            background: #1a1a1a;
            border: 2px solid #ffff00;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .acceleration-controls h3 {
            color: #ffff00;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ HIGH FREQUENCY TRADING SIMULATOR</h1>
            <p>Real-time Market Making & Order Book Analytics Engine</p>
            <div class="status">
                <span class="status-indicator status-offline" id="engine-status"></span>
                <span id="status-text">Engine Offline</span>
            </div>
        </div>
        
        <div class="acceleration-controls">
            <h3>‚ö° Acceleration Engine</h3>
            <div class="controls">
                <select id="acceleration-type">
                    <option value="cpu">CPU Only</option>
                    <option value="gpu">GPU Accelerated (10x)</option>
                    <option value="fpga">FPGA Accelerated (50x)</option>
                </select>
                <button onclick="initializeEngine()">Initialize Engine</button>
                <button onclick="toggleAcceleration()" id="accel-toggle" disabled>Enable Acceleration</button>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="startSimulation()" id="start-btn">Start Live Simulation</button>
            <button onclick="stopSimulation()" id="stop-btn" disabled>Stop Simulation</button>
            <button onclick="runBacktest()" id="backtest-btn">Run Historical Backtest</button>
            <button onclick="generateMarketData()" id="generate-btn">Generate Sample Data</button>
            <button onclick="resetEngine()" id="reset-btn">Reset Engine</button>
            <input type="file" id="data-file" accept=".json" onchange="loadHistoricalData(event)">
            <label for="data-file">Load NSE/BSE Data</label>
        </div>
        
        <div class="grid">
            <div class="panel">
                <h3>üìä Live Order Book</h3>
                <div class="orderbook" id="orderbook">
                    <div class="orderbook-side">
                        <strong class="ask">ASKS</strong>
                        <div id="asks"></div>
                    </div>
                    <div class="orderbook-side">
                        <strong class="bid">BIDS</strong>
                        <div id="bids"></div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>üìà Performance Metrics</h3>
                <div class="metrics" id="metrics">
                    <div class="metric">
                        <div class="metric-label">Total PnL</div>
                        <div class="metric-value" id="total-pnl">$0.00</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Max Drawdown</div>
                        <div class="metric-value" id="max-drawdown">$0.00</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Sharpe Ratio</div>
                        <div class="metric-value" id="sharpe-ratio">0.00</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Total Trades</div>
                        <div class="metric-value" id="total-trades">0</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value" id="win-rate">0%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Avg Latency</div>
                        <div class="metric-value" id="avg-latency">0.0ms</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Current Vol</div>
                        <div class="metric-value" id="current-vol">0.00%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Adverse Selection</div>
                        <div class="metric-value" id="adverse-selection">0.00</div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h3>üéØ Active Quotes</h3>
                <div id="active-quotes">
                    <p>No active quotes</p>
                </div>
            </div>
        </div>
        
        <div class="chart-container">
            <h3>üìâ PnL & Drawdown Chart</h3>
            <canvas id="pnl-chart" class="pnl-chart"></canvas>
        </div>
        
        <div class="panel">
            <h3>üìù Trade Log</h3>
            <div class="log" id="trade-log">
                Engine initialized. Ready to start trading...
            </div>
        </div>
    </div>

    <script type="module">
        import init, { HFTEngine, AcceleratedEngine } from './pkg/hft_simulator.js';
        
        let engine = null;
        let acceleratedEngine = null;
        let simulationInterval = null;
        let isRunning = false;
        let useAcceleration = false;
        let pnlHistory = [];
        let chart = null;
        
        // Initialize WASM module
        async function initWasm() {
            await init();
            console.log('WASM module initialized');
            updateStatus('Engine Ready', 'warning');
        }
        
        // Initialize engines
        window.initializeEngine = function() {
            const accelType = document.getElementById('acceleration-type').value;
            
            engine = new HFTEngine();
            acceleratedEngine = new AcceleratedEngine(accelType);
            
            updateStatus('Engine Initialized', 'online');
            document.getElementById('accel-toggle').disabled = false;
            log('Engine initialized with ' + accelType.toUpperCase() + ' configuration');
        };
        
        // Toggle acceleration
        window.toggleAcceleration = function() {
            useAcceleration = !useAcceleration;
            const btn = document.getElementById('accel-toggle');
            btn.textContent = useAcceleration ? 'Disable Acceleration' : 'Enable Acceleration';
            log('Acceleration ' + (useAcceleration ? 'enabled' : 'disabled'));
        };
        
        // Start simulation
        window.startSimulation = function() {
            if (!engine && !acceleratedEngine) {
                alert('Please initialize the engine first');
                return;
            }
            
            isRunning = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
            updateStatus('Live Trading', 'online');
            
            // Start market data simulation
            simulationInterval = setInterval(() => {
                const marketData = generateRealtimeMarketData();
                processMarketUpdate(marketData);
            }, 100); // 100ms intervals for high frequency
            
            log('Live simulation started');
        };
        
        // Stop simulation
        window.stopSimulation = function() {
            isRunning = false;
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            updateStatus('Engine Ready', 'warning');
            
            log('Simulation stopped');
        };
        
        // Generate sample market data
        window.generateMarketData = function() {
            const data = generateRealtimeMarketData();
            processMarketUpdate(data);
            log('Sample market data generated and processed');
        };
        
        // Reset engine
        window.resetEngine = function() {
            if (isRunning) {
                window.stopSimulation();
            }
            
            if (engine) engine = new HFTEngine();
            if (acceleratedEngine) {
                const accelType = document.getElementById('acceleration-type').value;
                acceleratedEngine = new AcceleratedEngine(accelType);
            }
            
            pnlHistory = [];
            updateMetricsDisplay({});
            document.getElementById('orderbook').innerHTML = '<p>No data</p>';
            document.getElementById('active-quotes').innerHTML = '<p>No active quotes</p>';
            
            log('Engine reset');
        };
        
        // Run backtest
        window.runBacktest = async function() {
            if (!engine) {
                alert('Please initialize the engine first');
                return;
            }
            
            document.getElementById('backtest-btn').disabled = true;
            log('Starting historical backtest...');
            
            // Generate historical data for backtest
            const historicalData = generateHistoricalData(10000); // 10k data points
            
            try {
                const results = await engine.backtest_historical_data(JSON.stringify(historicalData));
                const backtestResults = JSON.parse(results);
                
                log('Backtest completed with ' + backtestResults.length + ' snapshots');
                updateMetricsDisplay(JSON.parse(engine.get_performance_metrics()));
                
            } catch (error) {
                log('Backtest error: ' + error.toString());
            }
            
            document.getElementById('backtest-btn').disabled = false;
        };
        
        // Load historical data file
        window.loadHistoricalData = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    log('Loaded ' + data.length + ' historical data points');
                    
                    if (engine) {
                        engine.backtest_historical_data(JSON.stringify(data));
                        updateMetricsDisplay(JSON.parse(engine.get_performance_metrics()));
                    }
                } catch (error) {
                    log('Error loading file: ' + error.toString());
                }
            };
            reader.readAsText(file);
        };
        
        // Process market data update
        function processMarketUpdate(marketData) {
            const activeEngine = useAcceleration ? acceleratedEngine : engine;
            
            if (activeEngine) {
                try {
                    const method = useAcceleration ? 
                        'process_market_data_accelerated' : 
                        'process_market_data';
                    
                    const quotes = activeEngine[method](JSON.stringify(marketData));
                    
                    updateOrderBookDisplay(marketData.orderbook);
                    updateActiveQuotes(JSON.parse(quotes));
                    updateMetricsDisplay(JSON.parse(activeEngine.get_performance_metrics ? 
                        activeEngine.get_performance_metrics() : 
                        activeEngine.get_acceleration_metrics()));
                    
                } catch (error) {
                    log('Processing error: ' + error.toString());
                }
            }
        }
        
        // Generate realistic market data
        function generateRealtimeMarketData() {
            const basePrice = 100 + Math.sin(Date.now() / 10000) * 10;
            const spread = 0.01 + Math.random() * 0.02;
            
            const orderbook = {
                symbol: "NIFTY50",
                timestamp: Date.now(),
                bids: {},
                asks: {}
            };
            
            // Generate bid levels
            for (let i = 0; i < 10; i++) {
                const price = basePrice - (i + 1) * spread / 2;
                const key = Math.round((1000000 - price) * 100); // Inverted for bids
                orderbook.bids[key] = {
                    price: price,
                    quantity: Math.random() * 1000 + 100,
                    orders: Math.floor(Math.random() * 10) + 1
                };
            }
            
            // Generate ask levels
            for (let i = 0; i < 10; i++) {
                const price = basePrice + (i + 1) * spread / 2;
                const key = Math.round(price * 100);
                orderbook.asks[key] = {
                    price: price,
                    quantity: Math.random() * 1000 + 100,
                    orders: Math.floor(Math.random() * 10) + 1
                };
            }
            
            const trades = [];
            if (Math.random() < 0.3) { // 30% chance of trade
                trades.push({
                    price: basePrice + (Math.random() - 0.5) * spread,
                    quantity: Math.random() * 100 + 10,
                    timestamp: Date.now(),
                    side: Math.random() > 0.5 ? "buy" : "sell"
                });
            }
            
            return {
                orderbook: orderbook,
                trades: trades,
                timestamp: Date.now()
            };
        }
        
        // Generate historical data for backtesting
        function generateHistoricalData(count) {
            const data = [];
            let timestamp = Date.now() - count * 1000; // Start from 'count' seconds ago
            
            for (let i = 0; i < count; i++) {
                timestamp += 1000; // 1 second intervals
                
                const marketData = generateRealtimeMarketData();
                marketData.timestamp = timestamp;
                marketData.orderbook.timestamp = timestamp;
                
                data.push(marketData);
            }
            
            return data;
        }
        
        // Update UI displays
        function updateOrderBookDisplay(orderbook) {
            const asksDiv = document.getElementById('asks');
            const bidsDiv = document.getElementById('bids');
            
            let asksHtml = '';
            let bidsHtml = '';
            
            // Display top 5 asks
            const askEntries = Object.entries(orderbook.asks).slice(0, 5);
            for (const [, level] of askEntries) {
                asksHtml += `<div>${level.price.toFixed(2)} - ${level.quantity.toFixed(0)}</div>`;
            }
            
            // Display top 5 bids
            const bidEntries = Object.entries(orderbook.bids).slice(0, 5);
            for (const [, level] of bidEntries) {
                bidsHtml += `<div>${level.price.toFixed(2)} - ${level.quantity.toFixed(0)}</div>`;
            }
            
            asksDiv.innerHTML = asksHtml || '<div>No asks</div>';
            bidsDiv.innerHTML = bidsHtml || '<div>No bids</div>';
        }
        
        function updateActiveQuotes(quotes) {
            const quotesDiv = document.getElementById('active-quotes');
            
            if (quotes.length === 0) {
                quotesDiv.innerHTML = '<p>No active quotes</p>';
                return;
            }
            
            let html = '';
            for (const quote of quotes) {
                const sideClass = quote.side === 'buy' ? 'bid' : 'ask';
                html += `<div class="${sideClass}">
                    ${quote.side.toUpperCase()}: ${quote.price.toFixed(4)} x ${quote.quantity.toFixed(0)}
                </div>`;
            }
            
            quotesDiv.innerHTML = html;
        }
        
        function updateMetricsDisplay(metrics) {
            if (typeof metrics === 'string') {
                try {
                    metrics = JSON.parse(metrics);
                } catch (e) {
                    return;
                }
            }
            
            document.getElementById('total-pnl').textContent = 
                '$' + (metrics.total_pnl || 0).toFixed(2);
            document.getElementById('max-drawdown').textContent = 
                '$' + (metrics.max_drawdown || 0).toFixed(2);
            document.getElementById('sharpe-ratio').textContent = 
                (metrics.sharpe_ratio || 0).toFixed(2);
            document.getElementById('total-trades').textContent = 
                metrics.total_trades || 0;
            document.getElementById('win-rate').textContent = 
                ((metrics.win_rate || 0) * 100).toFixed(1) + '%';
            document.getElementById('avg-latency').textContent = 
                (metrics.avg_processing_time_ms || 0).toFixed(1) + 'ms';
            document.getElementById('current-vol').textContent = 
                ((metrics.current_volatility || 0) * 100).toFixed(2) + '%';
            document.getElementById('adverse-selection').textContent = 
                (metrics.adverse_selection_score || 0).toFixed(3);
            
            // Update PnL history for chart
            if (metrics.total_pnl !== undefined) {
                pnlHistory.push({
                    timestamp: Date.now(),
                    pnl: metrics.total_pnl,
                    drawdown: metrics.max_drawdown
                });
                
                // Keep only last 1000 points
                if (pnlHistory.length > 1000) {
                    pnlHistory.shift();
                }
                
                updatePnLChart();
            }
        }
        
        function updatePnLChart() {
            const canvas = document.getElementById('pnl-chart');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (pnlHistory.length < 2) return;
            
            const maxPnl = Math.max(...pnlHistory.map(p => p.pnl));
            const minPnl = Math.min(...pnlHistory.map(p => p.pnl));
            const range = Math.max(Math.abs(maxPnl), Math.abs(minPnl)) || 1;
            
            // Draw PnL line
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let i = 0; i < pnlHistory.length; i++) {
                const x = (i / (pnlHistory.length - 1)) * canvas.width;
                const y = canvas.height / 2 - (pnlHistory[i].pnl / range) * (canvas.height / 3);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
            
            // Draw zero line
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
        }
        
        function updateStatus(text, status) {
            document.getElementById('status-text').textContent = text;
            const indicator = document.getElementById('engine-status');
            indicator.className = 'status-indicator status-' + status;
        }
        
        function log(message) {
            const logDiv = document.getElementById('trade-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Initialize on page load
        initWasm();
    </script>
</body>
</html>
